---

- name: Ansible check Domain Config file exists.
  win_stat: 
    path: C:\Windows\Temp\bannik-create-carbon-domain.ps1
  register: domain_config 

- name: Ansible check Domain Users file exists.
  ansible.windows.win_stat:
    path: C:\Windows\Temp\bannik-create-carbon-users.ps1
  register: domain_users

- name: Ansible check DNS file exists.
  ansible.windows.win_stat:
    path: C:\Windows\Temp\bannik-set-dns-resolution.ps1
  register: dns_file

- name: Ansible WebServer Group file exists.
  ansible.windows.win_stat:
    path: C:\Windows\Temp\bannik-set-adalwolfa-group-membership.ps1
  register: webserver_group 

- name: Copy Domain Configuration Script bannik-create-carbon-domain.ps1
  ansible.windows.win_copy:
    src: files/turla/Resources/setup/files/carbon/bannik-create-carbon-domain.ps1  
    dest: C:\Windows\Temp\bannik-create-carbon-domain.ps1
  when: domain_config.stat.exists == False

- name: Copy Carbon Domain Groups and User Configuration bannik-create-carbon-users.ps1
  ansible.windows.win_copy:
    src: files/carbon/bannik-create-carbon-users.ps1 
    dest: C:\Windows\Temp\bannik-create-carbon-users.ps1
  when: domain_users.stat.exists == False
 
- name: Copy Carbon DNS Configuration bannik-set-dns-resolution.ps1
  ansible.windows.win_copy:
    src: files/turla/Resources/setup/files/carbon/bannik-set-dns-resolution.ps1
    dest: C:\Windows\Temp\bannik-set-dns-resolution.ps1
  when: dns_file.stat.exists == False
 
- name: Copy Group Membership for Websevers Configuration bannik-set-adalwolfa-group-membership.ps1
  ansible.windows.win_copy:
    src: files/turla/Resources/setup/files/carbon/bannik-set-adalwolfa-group-membership.ps1
    dest: C:\Windows\Temp\bannik-set-adalwolfa-group-membership.ps1
  when: webserver_group.stat.exists == False
 
- name: Set Domain 
  win_command: powershell.exe -ExecutionPolicy ByPass -File C:\Windows\Temp\bannik-create-carbon-domain.ps1
  when: domain_config.stat.exists == False

- name: (reboot) Wait for server to restart
  wait_for_connection:
    delay: 75 
  when: domain_config.stat.exists == False

- name: Configure Domain Groups and Users 
  win_command: powershell.exe -ExecutionPolicy ByPass -File C:\Windows\Temp\bannik-create-carbon-users.ps1
  when: domain_users.stat.exists == False

- name: Configure DNS
  win_command: powershell.exe -ExecutionPolicy ByPass -File C:\Windows\Temp\bannik-set-dns-resolution.ps1
  when: dns_file.stat.exists == False

- name: Add Kagarov to Group for WebServers 
  win_command: powershell.exe -ExecutionPolicy ByPass -File C:\Windows\Temp\bannik-set-adalwolfa-group-membership.ps1
  when: webserver_group.stat.exists == False
